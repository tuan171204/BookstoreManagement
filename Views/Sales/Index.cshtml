@{
    ViewData["Title"] = "B√°n H√†ng (POS)";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* --- Grid s·∫£n ph·∫©m --- */
    .product-grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 15px;
        max-height: 550px;
        overflow-y: auto;
        padding: 5px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }

    .book-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 220px;
    }

    .book-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-color: #0d6efd;
    }

    .book-card img {
        width: 100%;
        height: 140px;
        object-fit: cover;
        border-bottom: 1px solid #eee;
        background-color: #eee;
    }

    .book-info {
        padding: 8px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .book-title {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 4px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        height: 38px;
    }

    .book-price {
        color: #dc3545;
        font-weight: bold;
        font-size: 0.95rem;
    }

    /* Logic h·∫øt h√†ng */
    .book-card.disabled {
        background-color: #e9ecef;
        pointer-events: none;
        cursor: not-allowed;
    }

    .book-card.disabled img {
        filter: grayscale(100%);
        opacity: 0.6;
    }

    .out-of-stock-badge {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(50, 50, 50, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
        white-space: nowrap;
        z-index: 10;
    }

    /* --- Toast Notification --- */
    #toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast-message {
        background-color: #198754;
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        min-width: 250px;
        animation: slideIn 0.3s ease-out, fadeOut 0.5s 2.5s forwards;
    }

    .toast-message.warning {
        background-color: #fd7e14;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @@keyframes fadeOut {
        to {
            opacity: 0;
            visibility: hidden;
        }
    }
</style>

<div class="container-fluid px-4">

    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
        <h2><i class="fas fa-cash-register me-2"></i>B√°n h√†ng t·∫°i qu·∫ßy</h2>

        <div class="btn-group shadow-sm" role="group">
            <a href="#" class="btn btn-primary btn-lg active">
                <i class="fas fa-cart-plus me-1"></i> B√°n h√†ng (POS)
            </a>
            <a asp-action="List" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-history me-1"></i> L·ªãch s·ª≠ ƒë∆°n h√†ng
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-3 shadow-sm border-primary">
                <div class="card-body p-2">
                    <div class="input-group">
                        <select id="ddlCategory" class="form-select border-primary bg-light" style="max-width: 180px;"
                            asp-items="@(new SelectList(ViewBag.Categories, "CategoryId", "Name"))">
                            <option value="0">-- T·∫•t c·∫£ lo·∫°i --</option>
                        </select>
                        <input type="text" id="txtSearchBook" class="form-control border-primary"
                            placeholder="G√µ t√™n s√°ch ƒë·ªÉ t√¨m..." autocomplete="off">
                        <button class="btn btn-primary" onclick="searchBooks()"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center py-1">
                    <span><i class="fas fa-th me-1"></i> Danh s√°ch s·∫£n ph·∫©m</span>
                    <small class="text-muted">Click ·∫£nh ƒë·ªÉ th√™m</small>
                </div>
                <div class="card-body p-2">
                    <div id="productGrid" class="product-grid-container">
                        <div class="text-center py-5 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm" style="min-height: 300px;">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-shopping-basket me-1"></i> Gi·ªè h√†ng</span>
                    <div>
                        <button class="btn btn-sm btn-info text-white me-2" onclick="showCartModal()" title="Ph√≥ng to">
                            <i class="fas fa-expand"></i> Chi ti·∫øt
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearCart()" title="X√≥a h·∫øt">
                            <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£
                        </button>
                    </div>
                </div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 45%">T√™n S√°ch</th>
                                <th style="width: 25%" class="text-center">SL</th>
                                <th style="width: 20%" class="text-end">Th√†nh ti·ªÅn</th>
                                <th style="width: 10%"></th>
                            </tr>
                        </thead>
                        <tbody id="cartBody"></tbody>
                    </table>
                    <div id="emptyCartMessage" class="text-center py-4 text-muted">
                        <i class="fas fa-cart-arrow-down fa-3x mb-2 text-secondary"></i>
                        <h6>Gi·ªè h√†ng tr·ªëng</h6>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-white fw-bold">
                    Kh√°ch h√†ng
                    <span id="loadingCustomer" class="spinner-border spinner-border-sm text-primary ms-2"
                        style="display:none"></span>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="small text-muted">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" id="txtCustomerPhone" class="form-control"
                            placeholder="Nh·∫≠p SƒêT r·ªìi nh·∫•n Enter..." list="customerList" autocomplete="off">
                        <datalist id="customerList"></datalist>
                    </div>
                    <div class="mb-0">
                        <label class="small text-muted">T√™n kh√°ch h√†ng</label>
                        <input type="text" id="txtCustomerName" class="form-control" placeholder="T√™n kh√°ch (n·∫øu c√≥)">
                    </div>
                </div>
            </div>

            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-white fw-bold">Khuy·∫øn m√£i & ∆Øu ƒë√£i</div>
                <div class="card-body">
                    <select class="form-select" id="ddlPromotion">
                        <option value="0" data-min="0" data-type="0">-- Kh√¥ng √°p d·ª•ng --</option>
                    </select>
                </div>
            </div>

            <div class="card shadow-sm border-success">
                <div class="card-header bg-success text-white fw-bold text-center">
                    <i class="fas fa-file-invoice-dollar me-1"></i> THANH TO√ÅN
                </div>
                <div class="card-body bg-light">
                    <div class="d-flex justify-content-between mb-2">
                        <span>T·∫°m t√≠nh:</span>
                        <span class="fw-bold" id="lblSubTotal">0 ƒë</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-danger">
                        <span>Gi·∫£m gi√°:</span>
                        <span class="fw-bold" id="lblDiscount">-0 ƒë</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3 align-items-center">
                        <h5 class="text-success fw-bold m-0">T·ªîNG C·ªòNG:</h5>
                        <h3 class="text-success fw-bold m-0" id="lblFinalTotal">0 ƒë</h3>
                    </div>

                    <div class="mb-3">
                        <label class="small text-muted fw-bold">Nh√¢n vi√™n b√°n h√†ng:</label>
                        <select class="form-select border-primary" id="ddlEmployee">
                            @if (ViewBag.Employees != null)
                            {
                                foreach (var emp in ViewBag.Employees)
                                {
                                    // T·ª± ƒë·ªông ch·ªçn ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p
                                    if (User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == emp.Id)
                                    {
                                        <option value="@emp.Id" selected>@emp.FullName (T√¥i)</option>
                                    }
                                    else
                                    {
                                        <option value="@emp.Id">@emp.FullName</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="small text-muted">Ph∆∞∆°ng th·ª©c TT:</label>
                        <select class="form-select" id="ddlPaymentMethod">
                            <option value="Cash">Ti·ªÅn m·∫∑t</option>
                            <option value="Transfer">Chuy·ªÉn kho·∫£n</option>
                        </select>
                    </div>

                    <button id="btnPay" class="btn btn-success w-100 py-3 fw-bold text-uppercase fs-5 shadow">
                        Thanh to√°n ngay <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Chi ti·∫øt Gi·ªè h√†ng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-striped table-bordered mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">STT</th>
                            <th>T√™n s√°ch</th>
                            <th class="text-end">ƒê∆°n gi√°</th>
                            <th class="text-center">SL</th>
                            <th class="text-end">Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody id="modalCartBody"></tbody>
                </table>
            </div>
            <div class="modal-footer bg-light">
                <h5 class="me-auto text-primary fw-bold">T·ªïng: <span id="lblModalTotal">0 ƒë</span></h5>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-qrcode me-2"></i>Thanh to√°n Chuy·ªÉn kho·∫£n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <h6 class="text-danger fw-bold mb-3 animate__animated animate__pulse animate__infinite">
                    Vui l√≤ng qu√©t m√£ ƒë·ªÉ thanh to√°n
                </h6>

                <div class="position-relative d-inline-block">
                    <img id="vietqr-image" src="" alt="QR Code"
                        class="img-fluid border border-2 border-primary rounded p-2 mb-3 shadow"
                        style="max-width: 300px; min-height: 300px;">
                    <div id="qr-loading" class="position-absolute top-50 start-50 translate-middle"
                        style="display:none;">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>

                <h3 class="text-primary fw-bold mb-0" id="qr-amount">0 ƒë</h3>
                <div class="text-muted small mt-1">Ch·ªß TK: <b id="qr-name">...</b></div>
                <div class="text-muted small">N·ªôi dung: <b id="qr-content">...</b></div>

                <div class="alert alert-warning mt-3 mb-0 small text-start">
                    <i class="fas fa-info-circle me-1"></i>
                    Sau khi kh√°ch h√†ng chuy·ªÉn kho·∫£n th√†nh c√¥ng, vui l√≤ng ki·ªÉm tra tin nh·∫Øn ng√¢n h√†ng r·ªìi b·∫•m n√∫t <b>"X√°c
                        nh·∫≠n ƒë√£ thu ti·ªÅn"</b> b√™n d∆∞·ªõi.
                </div>
            </div>
            <div class="modal-footer justify-content-center bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy b·ªè</button>
                <button type="button" class="btn btn-success btn-lg px-4" onclick="confirmTransferSuccess()">
                    <i class="fas fa-check-circle me-2"></i> X√ÅC NH·∫¨N ƒê√É THU TI·ªÄN
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var cart = [];
        var initialBooks = @Html.Raw(ViewBag.InitialBooksJson ?? "[]");

        const MY_BANK = {
            BANK_ID: 'BIDV',        // M√£ ng√¢n h√†ng (BIDV, VCB, MB...)
            ACCOUNT_NO: '1170206622', // S·ªë t√†i kho·∫£n c·ªßa b·∫°n
            ACCOUNT_NAME: 'VƒÉn Th√†nh Thi·ªán', // T√™n ch·ªß t√†i kho·∫£n (Vi·∫øt hoa kh√¥ng d·∫•u)
            TEMPLATE: 'compact'     // Giao di·ªán QR (compact, print, qr_only)
        };

        $(document).ready(function () {
            loadPromotions();
            renderProductGrid(initialBooks);

            var searchTimer;
            $('#txtSearchBook').on('keyup', function () { clearTimeout(searchTimer); searchTimer = setTimeout(searchBooks, 300); });
            $('#ddlCategory').change(function () { searchBooks(); });
            $('#ddlPromotion').change(function () { renderCart(); });
            $('#btnPay').click(function () { handleCheckout(); });

            $('#txtCustomerPhone').on('input', function () {
                var phone = $(this).val();
                if (phone.length >= 3) { $.get('/Sales/SearchCustomers', { keyword: phone }, function (data) { var o = ''; data.forEach(p => { o += `<option value="${p}">` }); $('#customerList').html(o); }); }
            });

            $('#txtCustomerPhone').on('change keypress', function (e) {
                if (e.type === 'keypress' && e.which !== 13) return;
                if (e.which === 13) e.preventDefault();
                var phone = $(this).val(); if (phone.length < 9) return;
                $('#loadingCustomer').show();
                $.ajax({
                    url: '/Sales/GetCustomerInfo', type: 'GET', data: { phone: phone },
                    success: function (res) { $('#loadingCustomer').hide(); if (res.success) { $('#txtCustomerName').val(res.data.name).addClass('is-valid'); showToast(`ƒê√£ t√¨m th·∫•y: ${res.data.name}`); } else { $('#txtCustomerName').val('').removeClass('is-valid').focus(); } },
                    error: function () { $('#loadingCustomer').hide(); }
                });
            });
        });

        // --- RENDER GRID S·∫¢N PH·∫®M ---
        function renderProductGrid(books) {
            var grid = $('#productGrid'); grid.empty();
            if (!books || books.length === 0) { grid.html('<div class="text-center py-5 w-100 text-muted">Kh√¥ng t√¨m th·∫•y s√°ch.</div>'); return; }
            books.forEach(book => {
                var id = book.id || book.BookId || book.bookId;
                var title = book.title || book.Title; var price = book.price || book.Price; var stock = (book.stock !== undefined) ? book.stock : (book.Stock !== undefined ? book.Stock : 0);
                var imgUrl = book.imageUrl || book.ImageUrl || 'https://via.placeholder.com/150'; var isbn = book.isbn || book.SKU || "";
                var isOutOfStock = stock <= 0; var disabledClass = isOutOfStock ? "disabled" : "";
                var clickAction = (isOutOfStock || !id) ? "" : `addToCart(${id}, '${title.replace(/'/g, "\\'")}', ${price}, '${isbn}', ${stock})`;
                var html = `<div class="book-card ${disabledClass}" onclick="${clickAction}" title="T·ªìn kho: ${stock}">${isOutOfStock
                    ?
                    '<div class="out-of-stock-badge">H·∫æT H√ÄNG</div>'
                    :
                    ''}<img src="${imgUrl}"
                                                                     alt="${title}"
                                                                     onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                                                            <div class="book-info">
                                                            <div class="book-title" title="${title}">${title}
                                                            </div>
                                                            <div class="book-price">${price.toLocaleString('vi-VN')} ƒë</div>
                                                            <small class="text-${isOutOfStock ? 'muted' : 'success'}" style="font-size: 0.75rem;">${isOutOfStock ? 'T·∫°m h·∫øt' : 'C√≥ s·∫µn: ' + stock}</small></div></div>`;
                grid.append(html);
            });
        }

        // --- LOAD KHUY·∫æN M√ÉI (LOGIC M·ªöI: H·∫æT QU√Ä TR·ª™ TI·ªÄN) ---
        function loadPromotions() {
            $.get('/Sales/GetActivePromotions', function (data) {
                var ddl = $('#ddlPromotion'); ddl.empty(); ddl.append('<option value="0" data-min="0" data-type="0">-- Kh√¥ng √°p d·ª•ng --</option>');
                data.forEach(p => {
                    var label = p.name; var note = "";
                    if (p.typeId === 1) note = ` (-${p.value}%)`;
                    else if (p.typeId === 2) note = ` (-${p.value.toLocaleString()}ƒë)`;
                    else if (p.typeId === 3) {
                        if (p.giftStock > 0) note = ` (T·∫∑ng: ${p.giftName})`;
                        else note = ` (H·∫øt qu√† -> Tr·ª´ ${p.giftPrice.toLocaleString()}ƒë)`;
                    }
                    if (p.min > 0) note += ` [Min: ${p.min.toLocaleString()}ƒë]`;

                    // L∆∞u giftPrice v√†o data attribute
                    ddl.append(`<option value="${p.id}" data-type="${p.typeId}" data-value="${p.value}" data-min="${p.min}" data-gift-stock="${p.giftStock}" data-gift-price="${p.giftPrice}">${label}${note}</option>`);
                });
            });
        }

        // --- RENDER CART (T√çNH TO√ÅN) ---
        function renderCart() {
            var html = ''; var subTotal = 0;
            if (cart.length === 0) { $('#cartBody').html(''); $('#emptyCartMessage').show(); $('#lblSubTotal').text('0 ƒë'); $('#lblDiscount').text('-0 ƒë'); $('#lblFinalTotal').text('0 ƒë'); return; }
            $('#emptyCartMessage').hide();
            cart.forEach((item, index) => {
                subTotal += item.price * item.quantity;
                html += `<tr><td><div class="fw-bold text-truncate" style="max-width: 150px;">${item.title}</div></td><td class="text-center"><div class="input-group input-group-sm justify-content-center"><button class="btn btn-outline-secondary" onclick="updateQty(${index}, -1)">-</button><input type="text" class="form-control text-center p-0" style="max-width: 35px;" value="${item.quantity}" readonly><button class="btn btn-outline-secondary" onclick="updateQty(${index}, 1)">+</button></div></td><td class="text-end text-primary fw-bold">${(item.price * item.quantity).toLocaleString('vi-VN')}</td><td class="text-center"><button class="btn btn-link text-danger p-0" onclick="removeItem(${index})"><i class="fas fa-times"></i></button></td></tr>`;
            });
            $('#cartBody').html(html);

            var sel = $('#ddlPromotion option:selected');
            var minSpend = parseFloat(sel.attr('data-min')) || 0;
            var typeId = parseInt(sel.attr('data-type')) || 0;
            var val = parseFloat(sel.attr('data-value')) || 0;

            var giftStock = parseInt(sel.attr('data-gift-stock')) || 0;
            var giftPrice = parseFloat(sel.attr('data-gift-price')) || 0;

            var discount = 0; var label = '-0 ƒë';

            if (sel.val() > 0) {
                if (subTotal < minSpend) { label = '<span class="text-danger small fw-bold">(Ch∆∞a ƒë·ªß ƒêK)</span>'; }
                else {
                    if (typeId === 1) { discount = subTotal * (val / 100); label = `-${discount.toLocaleString('vi-VN')} ƒë (-${val}%)`; }
                    else if (typeId === 2) { discount = val; label = `-${discount.toLocaleString('vi-VN')} ƒë`; }
                    else if (typeId === 3) {
                        if (giftStock > 0) { discount = 0; label = '<span class="text-success small fw-bold">üéÅ ƒê∆∞·ª£c t·∫∑ng s√°ch</span>'; }
                        else {
                            // H·∫øt qu√† -> Tr·ª´ ti·ªÅn b·∫±ng gi√° s√°ch
                            discount = giftPrice;
                            label = `<span class="text-warning small fw-bold">‚ö†Ô∏è H·∫øt qu√†</span> -${discount.toLocaleString('vi-VN')} ƒë`;
                        }
                    }
                }
            }
            if (discount > subTotal) discount = subTotal;
            $('#lblSubTotal').text(subTotal.toLocaleString('vi-VN') + ' ƒë');
            $('#lblDiscount').html(label);
            $('#lblFinalTotal').text((subTotal - discount).toLocaleString('vi-VN') + ' ƒë');
        }

        // --- CART ACTIONS ---
        function addToCart(id, title, price, isbn, maxStock) {
            if (!id || id === 0) { showToast("D·ªØ li·ªáu s√°ch l·ªói. T·∫£i l·∫°i trang!", "warning"); return; }
            var item = cart.find(x => x.id === id);
            if (item) { if (item.quantity < maxStock) { item.quantity++; showToast("ƒê√£ tƒÉng s·ªë l∆∞·ª£ng: " + title); } else showToast('H·∫øt h√†ng!', 'warning'); }
            else { cart.push({ id: id, title: title, price: price, isbn: isbn, quantity: 1, maxStock: maxStock }); showToast("ƒê√£ th√™m: " + title); }
            renderCart();
        }

        function updateQty(index, delta) { var item = cart[index]; var newQty = item.quantity + delta; if (newQty > item.maxStock) { showToast('Kho kh√¥ng ƒë·ªß!', 'warning'); return; } if (newQty <= 0) removeItem(index); else { item.quantity = newQty; renderCart(); } }
        function removeItem(index) { cart.splice(index, 1); renderCart(); }
        function clearCart() { if (confirm('X√≥a h·∫øt?')) { cart = []; renderCart(); } }
        function searchBooks() { var k = $('#txtSearchBook').val(); var c = $('#ddlCategory').val(); if (!k && c == 0) { renderProductGrid(initialBooks); return; } $.get('/Sales/SearchBooks', { term: k, categoryId: c }, function (data) { renderProductGrid(data); }); }

        function handleCheckout() {
            // 1. Ki·ªÉm tra gi·ªè h√†ng
            if (cart.length === 0) { showToast('Gi·ªè h√†ng tr·ªëng!', 'warning'); return; }

            // 2. Ki·ªÉm tra ƒëi·ªÅu ki·ªán KM
            var sel = $('#ddlPromotion option:selected'); var min = parseFloat(sel.attr('data-min')) || 0; var sub = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            if (sel.val() > 0 && sub < min) { alert(`ƒê∆°n ch∆∞a ƒë·ªß ƒêK! Min: ${min.toLocaleString()}ƒë`); return; }

            // 3. L·∫•y ph∆∞∆°ng th·ª©c thanh to√°n
            var paymentMethod = $('#ddlPaymentMethod').val();

            // N·∫æU L√Ä CHUY·ªÇN KHO·∫¢N -> HI·ªÜN QR
            if (paymentMethod === 'Transfer') {
                showQRCode();
            } else {
                // N·∫æU L√Ä TI·ªÄN M·∫∂T -> X√ÅC NH·∫¨N R·ªíI L∆ØU
                if (confirm('X√°c nh·∫≠n thanh to√°n TI·ªÄN M·∫∂T?')) {
                    submitOrder();
                }
            }
        }

        // --- H√ÄM HI·ªÜN QR CODE ---
        function showQRCode() {
            // L·∫•y t·ªïng ti·ªÅn (l·ªçc b·ªè ch·ªØ ƒë v√† d·∫•u ch·∫•m)
            var totalText = $('#lblFinalTotal').text();
            var amount = parseInt(totalText.replace(/\D/g, ''));

            if (amount <= 0) { alert("S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá!"); return; }

            // T·∫°o n·ªôi dung chuy·ªÉn kho·∫£n ng·∫´u nhi√™n (ho·∫∑c theo m√£ ƒë∆°n)
            var orderInfo = "DH" + Math.floor(Math.random() * 1000000);

            // T·∫°o Link VietQR
            var qrUrl = `https://img.vietqr.io/image/${MY_BANK.BANK_ID}-${MY_BANK.ACCOUNT_NO}-${MY_BANK.TEMPLATE}.png?amount=${amount}&addInfo=${orderInfo}&accountName=${encodeURIComponent(MY_BANK.ACCOUNT_NAME)}`;

            // G√°n d·ªØ li·ªáu v√†o Modal
            $('#vietqr-image').attr('src', qrUrl);
            $('#qr-amount').text(totalText);
            $('#qr-content').text(orderInfo);
            $('#qr-name').text(MY_BANK.ACCOUNT_NAME);

            // Hi·ªán Modal
            var myModal = new bootstrap.Modal(document.getElementById('qrModal'));
            myModal.show();
        }

        // --- H√ÄM X√ÅC NH·∫¨N ƒê√É THU TI·ªÄN T·ª™ QR ---
        function confirmTransferSuccess() {
            // ·∫®n modal QR
            var modalEl = document.getElementById('qrModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // G·ªçi h√†m l∆∞u ƒë∆°n
            submitOrder();
        }

        // --- H√ÄM G·ª¨I ƒê∆†N H√ÄNG V·ªÄ SERVER (AJAX) ---
        function submitOrder() {
            var sel = $('#ddlPromotion option:selected');

            var payload = {
                CustomerPhone: $('#txtCustomerPhone').val(),
                CustomerName: $('#txtCustomerName').val(),

                // --- TH√äM D√íNG N√ÄY ƒê·ªÇ G·ª¨I ID NH√ÇN VI√äN ---
                EmployeeId: $('#ddlEmployee').val(),
                // ---------------------------------------

                PromotionId: parseInt(sel.val()) || 0,
                PaymentMethod: $('#ddlPaymentMethod').val(),
                CartItems: cart.map(x => ({ BookId: x.id, Title: x.title, Quantity: x.quantity }))
            };

            // Hi·ªÉn th·ªã loading (t√πy ch·ªçn)
            $('#btnPay').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...');

            $.ajax({
                url: '/Sales/Checkout',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (res) {
                    $('#btnPay').prop('disabled', false).html('Thanh to√°n ngay <i class="fas fa-arrow-right ms-2"></i>');
                    if (res.success) {
                        alert('‚úÖ ' + res.message);
                        location.reload();
                    } else {
                        alert('‚ùå ' + res.message);
                    }
                },
                error: function () {
                    $('#btnPay').prop('disabled', false).html('Thanh to√°n ngay <i class="fas fa-arrow-right ms-2"></i>');
                    alert('L·ªói k·∫øt n·ªëi Server!');
                }
            });
        }

        function showToast(msg, type = 'success') { var c = $('#toast-container'); var cls = type === 'success' ? '' : 'warning'; var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'; var t = $(`<div class="toast-message ${cls}"><i class="fas ${icon} me-2"></i> ${msg}</div>`); c.append(t); setTimeout(() => t.remove(), 3000); }
        function showCartModal() { if (cart.length === 0) { showToast("Gi·ªè tr·ªëng!", 'warning'); return; } var h = ''; var t = 0; cart.forEach((i, idx) => { t += i.price * i.quantity; h += `<tr><td class="text-center">${idx + 1}</td><td>${i.title}</td><td class="text-end">${i.price.toLocaleString()}</td><td class="text-center">${i.quantity}</td><td class="text-end fw-bold">${(i.price * i.quantity).toLocaleString()}</td></tr>`; }); $('#modalCartBody').html(h); $('#lblModalTotal').text(t.toLocaleString('vi-VN') + ' ƒë'); new bootstrap.Modal(document.getElementById('cartModal')).show(); }
    </script>
}