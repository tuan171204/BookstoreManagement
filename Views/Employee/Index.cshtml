@using Microsoft.AspNetCore.Identity
@using BookstoreManagement.Models;
@inject UserManager<AppUser> UserManager;


@* IEnumerable<T> = List kiểu <T> *@
@model IEnumerable<BookstoreManagement.Models.AppUser>

@{
    Layout = "_Layout";
    ViewData["Title"] = "Quản lý nhân viên";

    var roleDisplayNames = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
{
{ "Manager", "Quản lý" },
{ "Employee", "Nhân viên" }
};
}



<h2 class="content-title">@ViewData["Title"]</h2>
<partial name="_InputTextbox" />
<button id="delete-Employee-btn" style="display: none;"></button>
<button id="update-Employee-btn" style="display: none;"></button>
@Html.AntiForgeryToken()
<table class="table table-hover text-center employee-table">
    <thead>
        <tr>
            <th>Họ tên</th>
            <th>Số điện thoại</th>
            <th>Email</th>
            <th>Chức vụ</th>
            <th>Tình trạng</th>
        </tr>
    </thead>
    <tbody>
        @foreach (AppUser employee in Model)
        {
            <tr data-id="@employee.Id">
                <td>@employee.FullName</td>
                <td>@employee.PhoneNumber</td>
                <td>@employee.Email</td>
                <td>
                    @{
                        var roles = await UserManager.GetRolesAsync(employee);
                        var roleName = roles.FirstOrDefault() ?? "Chưa có";
                        var displayName = roleDisplayNames.ContainsKey(roleName) ? roleDisplayNames[roleName] : roleName;
                    }
                    @displayName
                </td>
                <td>
                    @if (!employee.IsActive)
                    {
                        <span class="badge bg-danger">Tạm khóa</span>
                    }
                    else
                    {
                        <span class="badge bg-success">Hoạt động</span>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>


<script>
    document.addEventListener("DOMContentLoaded", () => {

        // Lấy tất cả các hàng trong bảng
    const rows = document.querySelectorAll(".employee-table tbody tr");
    const modalElement = document.getElementById("featureModal");
    const modalBody = document.getElementById("ModalBody");
    const bsModal = new bootstrap.Modal(modalElement);
    // Biến để nhớ hàng đang được chọn
    let selectedRow = null;

    rows.forEach(row => {
        row.addEventListener("click", (event) => {
            event.stopPropagation();

            // Bỏ chọn hàng trước đó
            if (selectedRow) {
                selectedRow.classList.remove("active-row");
            }

            // Đánh dấu hàng hiện tại
            row.classList.add("active-row");
            selectedRow = row;
        });
    });

    // Khi click ra ngoài bảng thì bỏ chọn
    document.addEventListener("click", (event) => {
        const isClickInsideTable = event.target.closest(".employee-table");
        if (!isClickInsideTable && selectedRow) {
            selectedRow.classList.remove("active-row");
            selectedRow = null;
        }
    });

    document.querySelector("#delete-Employee-btn").addEventListener("click", async (e) => {
        e.preventDefault();
        if (!selectedRow) {
            alert("Vui lòng chọn một nhân viên để xóa!");
            return;
        }
        const id = selectedRow.dataset.id;
        const confirmDelete = confirm("Bạn có chắc chắn muốn xóa nhân viên này không?");
        if (!confirmDelete) return;

        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const response = await fetch(`/Employee/Delete/${id}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": token
                }
            });

            const result = await response.json();

            alert(result.message);
            if (result.success) {
                selectedRow = null;
                location.reload();
            }

        } catch (error) {
            console.error("Lỗi khi xóa:", error);
            alert("Đã xảy ra lỗi khi xóa nhân viên!");
        }
    })

    document.querySelector("#update-Employee-btn").addEventListener("click", async (e) => {
        e.preventDefault()
        if (!selectedRow) {
            alert("Vui lòng chọn một nhân viên để cập nhật!");
            return;
        }
        const id = selectedRow.dataset.id;
        const response = await fetch(`/Employee/GetUpdateForm/?id=${id}`);
        const html = await response.text();
        modalBody.innerHTML = html;
        bindAjaxForm();
    })

     function bindAjaxForm() {
        const modalBody = document.getElementById("ModalBody");
        const form = modalBody.querySelector("form");
        if (!form) return;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: "POST",
                body: formData
            });

            const contentType = response.headers.get("content-type");

            if (contentType && contentType.includes("text/html")) {
                // Lỗi validation => load lại form có lỗi
                modalBody.innerHTML = await response.text();
                bindAjaxForm(); // Gắn lại sự kiện submit
            } else {
                const result = await response.json();
                if (result.success) {
                    bsModal.hide();
                    alert(result.message);
                    location.reload(); // Hoặc cập nhật bảng bằng JS
                }
            }
        });
    }

    })
</script>