@using Microsoft.AspNetCore.Authorization
@inject IAuthorizationService AuthorizationService

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Bookstore Online</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }

        .navbar-brand {
            font-weight: 700;
            color: #0d6efd !important;
        }

        .nav-link {
            font-weight: 500;
            color: #495057;
        }

        .nav-link:hover {
            color: #0d6efd;
        }

        .nav-item:hover {
            background: #ddd;
            border-radius: 10px;
        }

        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }

        .search-box {
            position: relative;
            width: 400px;
        }

        .search-box input {
            border-radius: 20px;
            padding-left: 35px;
            border: 0.5px solid #333333;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 10px;
            color: #adb5bd;
        }

        .footer {
            background: #fff;
            padding: 40px 0;
            border-top: 1px solid #dee2e6;
            margin-top: 50px;
        }

        #bookDetailModal {
            z-index: 1060 !important;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top py-3">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" asp-controller="Shopping" asp-action="Index">
                <i class="fas fa-book-open fa-lg"></i>
                <span>Bookstore</span>
            </a>

            <div class="d-flex gap-2 mx-auto">
                <form class="search-box">
                    <i class="fas fa-search"></i>
                    <input class="form-control" id="searchInput" type="search"
                        placeholder="Tìm kiếm sách, tác giả, thể loại...">
                </form>

                <button class="btn btn-outline-secondary rounded-pill px-3" data-bs-toggle="modal"
                    data-bs-target="#filterModal">
                    <i class="fas fa-filter"></i> Lọc
                </button>
            </div>

            <div class="d-flex align-items-center gap-3">

                @if (User.Identity.IsAuthenticated)
                {
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-dark"
                            id="userMenu" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle fa-xl me-1 text-secondary"></i>
                            <span class="d-none d-md-block">@User.Identity.Name</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 px-2 w-100" style="font-size: 1rem;">
                            <li>
                                <a class="dropdown-item p-2" asp-controller="Shopping" asp-action="MyOrders">Đơn
                                    hàng của
                                    tôi</a>
                            </li>
                            <li>
                                <a class="dropdown-item p-2" asp-controller="Shopping" asp-action="MyAccount">Tài khoản</a>
                            </li>

                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <form asp-controller="Account" asp-action="ClientLogout" method="post">
                                    <button type="submit" class="dropdown-item text-danger p-2">Đăng xuất</button>
                                </form>
                            </li>
                        </ul>
                    </div>
                }
                else
                {
                    <div class="d-flex gap-2">
                        <a asp-controller="Account" asp-action="ClientLogin"
                            class="btn btn-outline-primary btn-sm rounded-pill px-3">Đăng nhập</a>

                        <a asp-controller="Account" asp-action="Register"
                            class="btn btn-primary btn-sm rounded-pill px-3">Đăng ký</a>
                    </div>
                }

                <a href="#" class="btn btn-light position-relative rounded-circle p-3" id="cartIcon"
                    onclick="openCartSidebar()">
                    <i class="fas fa-shopping-cart" style="font-size: 1.3rem;"></i>
                    <span id="cartCountBadge"
                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                        style="font-size: 1rem;">
                        0
                    </span>
                </a>

                @if ((await AuthorizationService.AuthorizeAsync(User, "Admin.View")).Succeeded)
                {
                    <a asp-controller="Book" asp-action="Index" class="btn btn-warning btn-sm rounded-pill py-2 px-3"
                        style="font-size:16px">
                        <i class="fas fa-user-shield me-1"></i> Trang quản Trị
                    </a>
                }
            </div>
        </div>
    </nav>

    <div class="bg-white border-bottom py-3 d-none d-lg-block">
        <div class="container">
            <ul class="nav justify-content-center gap-4">
                <li class="nav-item">
                    <a href="#" class="nav-link ajax-filter py-0 small text-dark" data-type="hot">
                        <i class="fas fa-fire text-danger"></i> Hot (Bán chạy)
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link ajax-filter py-0 small text-dark" data-type="new">
                        <i class="fas fa-clock text-info"></i> Sách mới
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#all-books-area" class="nav-link py-0 small text-dark"> Tất cả sách
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link ajax-filter py-0 small text-dark" data-type="promotion">
                        <i class="fas fa-tags text-warning"></i> Khuyến mãi
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="offcanvas offcanvas-end w-25" tabindex="-1" id="cartSidebar" aria-labelledby="cartSidebarLabel">
        <div class="offcanvas-header bg-primary text-white">
            <h5 class="offcanvas-title" id="cartSidebarLabel"><i class="fas fa-shopping-basket me-2"></i>Giỏ hàng của
                bạn</h5>
            <button type="button" class="btn-close text-reset btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column">
            <div id="cartItemsContainer" class="flex-grow-1 overflow-auto">
                <div class="text-center text-muted p-5 small">Giỏ hàng trống.</div>
            </div>

            <div class="mt-3 pt-3 border-top">
                <div class="d-flex justify-content-between mb-2">
                    <span class="fw-bold">Tổng tiền (Tạm tính):</span>
                    <span class="fw-bold text-danger fs-5" id="cartTotalAmount">0 đ</span>
                </div>
                <a href="/Shopping/Checkout" class="btn btn-primary w-100 btn-lg">
                    <i class="fas fa-money-check-alt me-1"></i> Thanh toán
                </a>
            </div>
        </div>
    </div>

    <main role="main" class="pb-3">
        @RenderBody()
    </main>

    <footer class="footer text-center text-muted small">
        <div class="container">
            &copy; 2025 - Bookstore Management - <a href="#">Privacy</a>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js">
    </script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="https://kit.fontawesome.com/5ca8a4e942.js" crossorigin="anonymous"></script>


    <script>
        function renderBookResult(book) {
            // Thay thế logic format tiền tệ bằng hàm có sẵn của JS
            const priceHtml = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0 }).format(book.price);
            const saleBadge = book.isOnSale ? '<span class="badge bg-danger position-absolute top-0 start-0 mt-1 ms-1">SALE</span>' : '';


            return `
                <div class="d-flex align-items-center mb-2 p-2 border-bottom book-search-item" data-id="${book.id}" style="cursor: pointer;">
                    <div class="position-relative me-2">
                        ${saleBadge}
                        <img src="${book.imageUrl}" alt="${book.title}" style="width: 60px; height: 80px; object-fit: cover;" class="rounded shadow-sm">
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold text-truncate" style="font-size: 1.1rem;">${book.title}</div>
                        <div class="text-muted small">${book.authorName}</div>
                    </div>
                    <span class="text-primary fw-bold ms-3">${priceHtml}</span>
                </div>
            `;
        }

        // Function to render the search result item (Author)
        function renderAuthorResult(author) {
            // Tên ảnh trong DB của bạn không có path, nên cần prefix /images/authors/
            const avatarUrl = author.imageUrl ? '/images/authors/' + author.imageUrl : 'https://via.placeholder.com/50x50/ccc/fff?text=TG';

            return `
                <div class="d-flex align-items-center mb-2 p-2 border-bottom author-search-item" data-id="${author.id}" style="cursor: pointer;">
                    <img src="${avatarUrl}" alt="${author.name}" style="width: 50px; height: 50px; object-fit: cover;" class="rounded-circle me-3">
                    <div class="flex-grow-1">
                        <div class="fw-bold text-dark">${author.name}</div>
                        <div class="text-muted small">${author.bookCount} cuốn sách</div>
                    </div>
                    <span class="badge bg-info text-dark ms-3">Tác giả</span>
                </div>
            `;
        }

        // Global Debounce function
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        $(document).ready(function () {
            const searchInput = $('#searchInput');
            // Thêm thẻ div container cho search results vào ngay sau input
            searchInput.after('<div id="searchResultsDropdown" class="position-absolute bg-white shadow-lg rounded mt-1 p-3 border" style="z-index: 1050; width: 100%; display: none;"></div>');
            const searchDropdown = $('#searchResultsDropdown');

            function handleSearch(term) {
                if (term.length < 3) {
                    searchDropdown.hide().empty();
                    return;
                }

                searchDropdown.show().html('<div class="text-center text-muted p-2"><div class="spinner-border spinner-border-sm me-2"></div>Đang tìm kiếm...</div>');

                $.ajax({
                    url: '/Shopping/SearchAll',
                    type: 'GET',
                    data: { term: term },
                    success: function (res) {
                        let html = '';

                        // 1. Authors
                        if (res.authors && res.authors.length > 0) {
                            html += '<div class="fw-bold text-secondary mb-1 border-bottom">Tác giả phù hợp</div>';
                            res.authors.forEach(author => {
                                html += renderAuthorResult(author);
                            });
                        }

                        // 2. Books
                        if (res.books && res.books.length > 0) {
                            html += '<div class="fw-bold text-secondary my-1 border-bottom">Sách phù hợp</div>';
                            res.books.forEach(book => {
                                html += renderBookResult(book);
                            });
                        }

                        if (html === '') {
                            html = '<div class="text-center text-muted p-3">Không tìm thấy kết quả nào.</div>';
                        }

                        searchDropdown.html(html);

                        // Add click event for books to show modal
                        $('.book-search-item').on('click', function () {
                            const bookId = $(this).data('id');
                            searchDropdown.hide();
                            searchInput.val('');
                            // Gọi hàm showBookDetails (đã được định nghĩa ở Index.cshtml)
                            if (typeof showBookDetails === 'function') {
                                showBookDetails(bookId);
                            }
                        });

                        $('.author-search-item',).on('click', function () {
                            const authorId = $(this).data('id');
                            $('#searchResultsDropdown').hide(); // Ẩn dropdown tìm kiếm
                            $('#searchInput').val('');          // Xóa text tìm kiếm

                            showAuthorDetails(authorId);        // Gọi hàm mở modal
                        });
                    },
                    error: function () {
                        searchDropdown.html('<div class="alert alert-danger p-2 small">Lỗi kết nối tìm kiếm.</div>');
                    }
                });
            }

            // Debounce search input
            searchInput.on('keyup', debounce(function () {
                handleSearch($(this).val());
            }, 300));

            // Hide dropdown when clicking outside
            $(document).on('click', function (e) {
                if (!$(e.target).closest('.search-box').length) {
                    searchDropdown.hide().empty();
                }
            });

            // Prevent form submission on Enter
            searchInput.closest('form').on('submit', function (e) {
                e.preventDefault();
            });
        });

        // --- HÀM MỚI: MỞ MODAL TÁC GIẢ ---
        function showAuthorDetails(authorId) {
            var myModal = new bootstrap.Modal(document.getElementById('authorDetailModal'));

            // Reset loading state
            document.getElementById('authorDetailContent').innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-info" role="status"></div>
            <p class="mt-2 text-muted">Đang tải thông tin tác giả...</p>
        </div>`;

            myModal.show();

            $.ajax({
                url: '/Shopping/GetAuthorDetails',
                type: 'GET',
                data: { id: authorId },
                success: function (res) {
                    $('#authorDetailContent').html(res);
                },
                error: function () {
                    $('#authorDetailContent').html('<div class="text-center p-5 text-danger">Lỗi tải dữ liệu.</div>');
                }
            });
        }

        // ==== CHỨC NĂNG GIỎ HÀNG ====
        // ==== CÁC BIẾN VÀ HÀM CƠ BẢN ====
        let clientCart = [];
        const CART_STORAGE_KEY = 'bookstore_client_cart';
        let cartOffcanvasInstance = null; // Khởi tạo biến lưu instance Offcanvas
        const formatCurrency = (amount) => amount.toLocaleString('vi-VN') + ' đ';
        
        // Kiểm tra trạng thái đăng nhập (từ Razor)
        const isUserAuthenticated = @((User.Identity?.IsAuthenticated ?? false).ToString().ToLower());


        // --- Hàm 0: Khởi tạo/Đồng bộ giỏ hàng từ localStorage ---
        function initializeCart() {
            const storedCart = localStorage.getItem(CART_STORAGE_KEY);
            if (storedCart) {
                try {
                    clientCart = JSON.parse(storedCart);
                } catch (e) {
                    clientCart = [];
                }
            }
            updateCartCountUI();
        }

        // --- Hàm 1: Cập nhật UI Badge số lượng ---
        function updateCartCountUI() {
            const totalCount = clientCart.reduce((sum, item) => sum + item.qty, 0);
            $('#cartCountBadge').text(totalCount);
        }

        // --- Hàm 2: Thêm sản phẩm vào giỏ hàng ---
        function addToCart(bookId, quantity = 1) {
            // Kiểm tra đăng nhập trước khi thêm vào giỏ
            if (!isUserAuthenticated) {
                // Chưa đăng nhập - Hiển thị thông báo và redirect đến trang đăng nhập với returnUrl
                if (confirm("Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng.\n\nBạn có muốn đăng nhập ngay bây giờ không?")) {
                    const currentUrl = window.location.pathname + window.location.search;
                    window.location.href = '/Account/ClientLogin?returnUrl=' + encodeURIComponent(currentUrl);
                }
                return;
            }

            const existingItem = clientCart.find(item => item.id === bookId);

            if (existingItem) {
                existingItem.qty += quantity;
            } else {
                clientCart.push({ id: bookId, qty: quantity });
            }

            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(clientCart));
            updateCartCountUI();
            alert("Đã thêm sản phẩm vào giỏ!");
        }


        // --- Hàm MỚI: Tải lại nội dung giỏ hàng (Không mở/đóng Offcanvas) ---
        function reloadCartContent() {
            if (clientCart.length === 0) {
                // Nếu giỏ trống, không cần gọi API
                $('#cartItemsContainer').html('<div class="text-center text-muted p-5 small">Giỏ hàng trống.</div>');
                $('#cartTotalAmount').text('0 đ');
                return;
            }

            const bookIds = clientCart.map(item => item.id).join(',');
            const container = $('#cartItemsContainer');

            // Hiển thị Loading
            container.html('<div class="text-center mt-5"><div class="spinner-border spinner-border-sm me-2"></div>Đang tải giỏ hàng...</div>');
            $('#cartTotalAmount').text('...');

            // Gọi API để lấy thông tin chi tiết (giá, ảnh, tên)
            $.ajax({
                url: '/Shopping/GetCartDetails',
                type: 'GET',
                data: { bookIds: bookIds },
                success: function (res) {
                    if (res.success && res.items.length > 0) {
                        renderCartItems(res.items);
                    } else {
                        reloadCartContent(); // Nếu API trả về trống do sách bị xóa/hết hàng
                    }
                },
                error: function () {
                    container.html('<div class="alert alert-danger small">Lỗi tải dữ liệu giỏ hàng.</div>');
                }
            });
        }


        // --- Hàm 3: Mở Side-bar Giỏ hàng và tải dữ liệu ---
        function openCartSidebar() {
            if (clientCart.length === 0) {
                alert("Giỏ hàng của bạn đang trống!");
                return;
            }

            // Khởi tạo instance nếu chưa có
            if (!cartOffcanvasInstance) {
                const sidebarElement = document.getElementById('cartSidebar');
                cartOffcanvasInstance = new bootstrap.Offcanvas(sidebarElement);
            }

            // Chỉ gọi show() nếu nó đang ẩn (Ngăn chặn tạo backdrop mới)
            if (!cartOffcanvasInstance._isShown) {
                cartOffcanvasInstance.show();
            }

            // Luôn tải lại nội dung
            reloadCartContent();
        }

        // --- Hàm 4: Render nội dung giỏ hàng (ĐÃ SỬA INPUT) ---
        function renderCartItems(dbItems) {
            let total = 0;
            let html = '';

            clientCart.forEach(localItem => {
                const dbInfo = dbItems.find(db => db.bookId === localItem.id);

                if (dbInfo) {
                    const subtotal = dbInfo.price * localItem.qty;
                    total += subtotal;

                    html += `
                <div class="d-flex align-items-start border-bottom py-2 cart-item-row" data-id="${dbInfo.bookId}">
                    <img src="${dbInfo.imageUrl}" class="rounded me-2" style="width: 70px; height: 100px; object-fit: cover;">
                    <div class="flex-grow-1 small mx-2">
                        <div class="fw-bold text-truncate" style="font-size:16px">${dbInfo.title}</div>
                        <div class="text-muted small" style="font-size:16px">${formatCurrency(dbInfo.price)}</div>
                        
                        <div class="input-group input-group-sm mt-1" style="width: 100px;">
                            <button class="btn btn-outline-secondary" type="button" onclick="changeItemQuantity(${dbInfo.bookId}, -1)">-</button>
                            <input type="number" class="form-control text-center" value="${localItem.qty}" min="1" max="${dbInfo.stock}" 
                                onchange="changeItemQuantity(${dbInfo.bookId}, 0, this.value)" readonly> 
                            <button class="btn btn-outline-secondary" type="button" onclick="changeItemQuantity(${dbInfo.bookId}, 1)">+</button>
                        </div>
                    </div>
                    
                    <div class="text-end ms-auto">
                        <span class="text-danger fw-bold d-block mb-1">${formatCurrency(subtotal)}</span>
                        <button class="btn btn-sm btn-outline-danger border-0 p-2" onclick="removeItemFromCart(${dbInfo.bookId})">
                            <i class="fas fa-trash small"></i> Xóa
                        </button>
                    </div>
                </div>
            `;
                }
            });

            $('#cartItemsContainer').html(html);
            $('#cartTotalAmount').text(formatCurrency(total));
        }


        // --- Hàm 5: Xóa sản phẩm khỏi giỏ (ĐÃ FIX BACKDROP) ---
        function removeItemFromCart(bookId) {
            if (confirm("Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ?")) {
                clientCart = clientCart.filter(item => item.id !== bookId);

                localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(clientCart));
                updateCartCountUI();

                if (clientCart.length === 0) {
                    // FIX: Đóng sidebar và đảm bảo backdrop bị xóa
                    const sidebarElement = document.getElementById('cartSidebar');
                    const sidebar = bootstrap.Offcanvas.getInstance(sidebarElement);

                    if (sidebar) {
                        sidebar.hide();
                        // Dùng setTimeout để đợi animation đóng hoàn thành rồi xóa backdrop
                        setTimeout(() => {
                            document.querySelector('.offcanvas-backdrop')?.remove();
                        }, 300);
                    }
                    // Cập nhật giao diện trống ngay lập tức
                    $('#cartItemsContainer').html('<div class="text-center text-muted p-5 small">Giỏ hàng trống.</div>');
                    $('#cartTotalAmount').text('0 đ');

                } else {
                    // Nếu giỏ vẫn còn hàng, chỉ cần tải lại nội dung (không mở lại Offcanvas)
                    reloadCartContent(); // <--- Sửa ở đây
                }
            }
        }


        // --- Hàm 6: Thay đổi số lượng sản phẩm trong giỏ (ĐÃ FIX BACKDROP) ---
        function changeItemQuantity(bookId, delta, manualQty = null) {
            const item = clientCart.find(item => item.id === bookId);
            if (!item) return;

            let newQty;

            if (manualQty !== null) {
                newQty = parseInt(manualQty);
                if (isNaN(newQty)) return;
            } else {
                newQty = item.qty + delta;
            }

            if (newQty < 1) {

                removeItemFromCart(bookId);

                return;
            }

            // Có thể thêm kiểm tra tồn kho tại đây (ví dụ: if (newQty > dbInfo.stock))

            item.qty = newQty;

            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(clientCart));
            updateCartCountUI();

            // Tải lại nội dung Sidebar để cập nhật tổng tiền
            reloadCartContent(); // <--- Sửa ở đây
        }


        // --- Khởi tạo ---
        $(document).ready(function () {
            initializeCart();
        });

    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>

</html>