@model IEnumerable<BookstoreManagement.Models.Book>
@{
    ViewData["Title"] = "Trang chủ";
    Layout = "~/Views/Shared/_LayoutClient.cshtml";

    var initialFeaturedBooks = ViewBag.FeaturedBooks as List<BookstoreManagement.Models.Book>;
    var featuredBooks = ViewBag.FeaturedBooks as List<BookstoreManagement.Models.Book>;
    string featuredTitle = ViewBag.FeaturedTitle as string;
    string currentType = ViewBag.CurrentType as string;
}
@* 
@if (currentType == "normal" || string.IsNullOrEmpty(currentType))
{
    <div class="container mt-4">
        <div class="p-5 mb-4 bg-light rounded-3 shadow-sm border"
            style="background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);">
            <div class="container-fluid py-3">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-5 fw-bold text-primary">Chào mừng đến Bookstore</h1>
                        <p class="lead mb-4">Khám phá thế giới tri thức vô tận với hàng ngàn đầu sách hấp dẫn đang chờ đón
                            bạn.</p>
                        <a href="#all-books-area" class="btn btn-primary btn-lg rounded-pill px-4">Mua ngay</a>
                    </div>
                    <div class="col-md-4 text-center">
                        <img src="/images/banner-book.png"
                            onerror="this.src='https://via.placeholder.com/200x300?text=Bookstore'" class="shadow rounded"
                            alt="Hero Book" style="max-height: 250px;">
                    </div>
                </div>
            </div>
        </div>
    </div>
} *@

<div id="featured-container" class="container mb-5 mt-4">
    @await Html.PartialAsync("_FeaturedSection", initialFeaturedBooks)
</div>


<div class="container mb-5" id="all-books-area">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold m-0 text-uppercase border-start border-4 border-secondary ps-2">Tất cả sách</h4>
        <a href="#" class="text-decoration-none small text-muted">Xem thêm <i class="fas fa-chevron-down"></i></a>
    </div>

    <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4">
        @foreach (var book in Model)
        {
            // --- LOGIC TÍNH GIÁ KHUYẾN MÃI TẠI VIEW ---
            var now = DateTime.Now;

            // 1. Lấy khuyến mãi toàn sàn từ ViewBag
            var globalPromo = ViewBag.GlobalPromo as BookstoreManagement.Models.Promotion;

            // 2. Tìm khuyến mãi riêng (Specific) ưu tiên cao nhất
            var specificPromo = book.BookPromotions
            .Where(bp => bp.Promotion.IsActive == true
            && bp.Promotion.ApplyType == "Specific"
            && (bp.Promotion.EndDate == null || bp.Promotion.EndDate >= now)
            && (bp.Promotion.ApplyChannel == "All" || bp.Promotion.ApplyChannel == "Online"))
            .Select(bp => bp.Promotion)
            .FirstOrDefault();

            // 3. Quyết định khuyến mãi nào được áp dụng
            var activePromo = specificPromo ?? globalPromo;

            decimal originalPrice = book.Price;
            decimal finalPrice = originalPrice;
            bool isDiscounted = false;
            string badgeHtml = "";

            if (activePromo != null)
            {
                isDiscounted = true;
                decimal discountAmount = 0;

                if (activePromo.TypeId == 1) // %
                {
                    discountAmount = originalPrice * (activePromo.DiscountPercent ?? 0) / 100;
                    badgeHtml = $"<span class='position-absolute top-0 start-0 m-2 badge       bg-danger'>-{activePromo.DiscountPercent?.ToString("0")}%</span>";
                }
                else if (activePromo.TypeId == 2) // Tiền mặt
                {
                    discountAmount = activePromo.DiscountPercent ?? 0;
                    badgeHtml = $"<span class='position-absolute top-0 start-0 m-2 badge       bg-danger'>-{discountAmount.ToString("N0")}đ</span>";
                }

                finalPrice = originalPrice - discountAmount;
                if (finalPrice < 0) finalPrice = 0;
            }

            <div class="col">
                <div class="card h-100 border-0 shadow-sm book-card" onclick="showBookDetails(@book.BookId)"
                    style="cursor: pointer;">
                    <div class="position-relative text-center p-3 bg-white">
                        <img src="@book.ImageUrl" class="card-img-top shadow-sm"
                            style="height: 160px; width: auto; object-fit: cover;" alt="@book.Title">

                        @if ((book.StockQuantity ?? 0) == 0)
                        {
                            <span class="position-absolute top-0 start-0 m-2 badge bg-secondary">Hết hàng</span>
                        }
                        else if (isDiscounted)
                        {
                            @Html.Raw(badgeHtml)
                        }
                    </div>

                    <div class="card-body d-flex flex-column p-2">
                        <h6 class="card-title fw-bold text-truncate small mb-1" title="@book.Title">@book.Title</h6>
                        <p class="card-text text-muted small mb-2" style="font-size: 0.8rem;">@book.Author?.Name</p>

                        <div class="mt-auto d-flex justify-content-between align-items-center">
                            <div>
                                @if (isDiscounted)
                                {
                                    <div class="text-decoration-line-through text-muted small" style="font-size: 0.8rem;">
                                        @originalPrice.ToString("N0") đ</div>
                                    <span class="fw-bold text-danger">@finalPrice.ToString("N0") đ</span>
                                }
                                else
                                {
                                    <span class="fw-bold text-primary">@originalPrice.ToString("N0") đ</span>
                                }
                            </div>

                            <button class="btn btn-sm btn-outline-primary rounded-circle"
                                onclick="event.stopPropagation(); addToCart(@book.BookId)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    
    @* Pagination cho all books *@
    @if (ViewBag.TotalAllPages > 1)
    {
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                @{
                    int currentPage = ViewBag.AllBooksPageNumber ?? 1;
                    int totalPages = ViewBag.TotalAllPages ?? 1;
                    
                    Func<int, string> GetPageUrl = (pageNum) =>
                    {
                        // Chỉ giữ pageNumber, loại bỏ tất cả filter parameters
                        return $"?pageNumber={pageNum}";
                    };
                }
                
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@GetPageUrl(currentPage - 1)" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                
                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" href="@GetPageUrl(i)">@i</a>
                    </li>
                }
                
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" href="@GetPageUrl(currentPage + 1)" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
            <div class="text-center text-muted small mt-2">
                Trang @currentPage / @totalPages (@(ViewBag.TotalAllBooks ?? 0) sách)
            </div>
        </nav>
    }
</div>


<div class="modal fade" id="authorDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" id="authorDetailContent">
            <div class="text-center p-5">
                <div class="spinner-border text-info" role="status"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" id="bookDetailContent">
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold"><i class="fas fa-sliders-h me-2"></i>Bộ lọc tìm kiếm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">Thể loại sách</label>
                        <select class="form-select" id="filterCategory">
                            <option value="">-- Tất cả thể loại --</option>
                            @if (ViewBag.Categories != null)
                            {
                                foreach (var item in ViewBag.Categories)
                                {
                                    <option value="@item.CategoryId">@item.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">Tác giả</label>
                        <select class="form-select" id="filterAuthor">
                            <option value="">-- Tất cả tác giả --</option>
                            @if (ViewBag.Authors != null)
                            {
                                foreach (dynamic item in ViewBag.Authors)
                                {
                                    <option value="@item.AuthorId">@item.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">Nhà xuất bản</label>
                        <select class="form-select" id="filterPublisher">
                            <option value="">-- Tất cả NXB --</option>
                            @if (ViewBag.Publishers != null)
                            {
                                foreach (dynamic item in ViewBag.Publishers)
                                {
                                    <option value="@item.PublisherId">@item.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted">Khoảng giá (VNĐ)</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" class="form-control" id="filterMinPrice" placeholder="Từ" min="0"
                                step="1000">
                            <span>-</span>
                            <input type="number" class="form-control" id="filterMaxPrice" placeholder="Đến" min="0"
                                step="1000">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary px-4" id="btnApplyFilter">
                    <i class="fas fa-search me-1"></i> Tìm ngay
                </button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function () {
            $('.ajax-filter').click(function (e) {
                e.preventDefault(); // Ngăn chặn load lại trang

                var type = $(this).data('type');
                var container = $('#featured-container');

                // 1. Cập nhật UI Active cho menu
                $('.ajax-filter').removeClass('text-primary fw-bold').addClass('text-dark');
                $(this).removeClass('text-dark').addClass('text-primary fw-bold');

                // 2. Hiển thị Loading
                container.html(`
                                                                    <div class="text-center py-5">
                                                                        <div class="spinner-border text-primary" role="status"></div>
                                                                        <p class="mt-2 text-muted">Đang tải dữ liệu...</p>
                                                                    </div>
                                                                `);

                // 3. Gọi AJAX về Server
                $.ajax({
                    url: '/Shopping/Index',
                    type: 'GET',
                    data: {
                        type: type,
                        isAjax: true // Báo hiệu cho Controller biết đây là AJAX
                    },
                    success: function (response) {
                        // Đổ HTML nhận được vào container
                        container.html(response);
                    },
                    error: function () {
                        container.html('<div class="alert alert-danger text-center">Lỗi tải dữ liệu. Vui lòng thử lại.</div>');
                    }
                });
            });

            // --- XỬ LÝ PAGINATION CHO FILTER (AJAX) ---
            // Chỉ xử lý pagination trong #featured-container (filter results)
            $(document).on('click', '#featured-container .pagination .page-link', function(e) {
                e.preventDefault();
                var href = $(this).attr('href');
                if (!href || href === '#') return;
                
                // Parse URL để lấy parameters
                var url = new URL(href, window.location.origin);
                var params = {};
                url.searchParams.forEach((value, key) => {
                    params[key] = value;
                });
                
                // Thêm isAjax và type=filter
                params.isAjax = true;
                params.type = 'filter';
                
                var container = $('#featured-container');
                container.html(`
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Đang tải dữ liệu...</p>
                    </div>
                `);
                
                $.ajax({
                    url: '/Shopping/Index',
                    type: 'GET',
                    data: params,
                    success: function (response) {
                        container.html(response);
                        $('html, body').animate({
                            scrollTop: container.offset().top - 100
                        }, 500);
                    },
                    error: function () {
                        container.html('<div class="alert alert-danger text-center">Có lỗi xảy ra khi tải dữ liệu.</div>');
                    }
                });
            });
            
            // Pagination của "tất cả sách" sẽ dùng normal page reload (không cần xử lý JavaScript)
            
            // --- XỬ LÝ BỘ LỌC NÂNG CAO ---
            $('#btnApplyFilter').click(function () {
                // 1. Lấy dữ liệu từ form
                var categoryId = $('#filterCategory').val();
                var authorId = $('#filterAuthor').val();
                var publisherId = $('#filterPublisher').val();
                var minPrice = $('#filterMinPrice').val();
                var maxPrice = $('#filterMaxPrice').val();
                
                // Validate: Nếu không có filter nào được chọn, thông báo
                if (!categoryId && !authorId && !publisherId && !minPrice && !maxPrice) {
                    alert('Vui lòng chọn ít nhất một tiêu chí lọc!');
                    return;
                }

                // 2. Đóng modal
                var filterModal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
                filterModal.hide();

                // 3. Hiển thị Loading & Scroll tới vùng kết quả
                var container = $('#featured-container');
                $('html, body').animate({
                    scrollTop: container.offset().top - 100
                }, 500);

                container.html(`
                                                                <div class="text-center py-5">
                                                                    <div class="spinner-border text-primary" role="status"></div>
                                                                    <p class="mt-2 text-muted">Đang lọc dữ liệu...</p>
                                                                </div>
                                                            `);

                // 4. Reset style menu active (vì đang dùng filter riêng)
                $('.ajax-filter').removeClass('text-primary fw-bold').addClass('text-dark');

                // 5. Gọi AJAX
                $.ajax({
                    url: '/Shopping/Index',
                    type: 'GET',
                    data: {
                        type: 'filter',
                        isAjax: true,
                        categoryId: categoryId,
                        authorId: authorId,
                        publisherId: publisherId,
                        minPrice: minPrice,
                        maxPrice: maxPrice,
                        pageNumber: 1 // Reset về trang đầu khi filter
                    },
                    success: function (response) {
                        container.html(response);
                    },
                    error: function () {
                        container.html('<div class="alert alert-danger text-center">Có lỗi xảy ra khi lọc dữ liệu.</div>');
                    }
                });
            });
        });


        // Hàm gọi AJAX để mở Modal
        // --- KHAI BÁO BIẾN TOÀN CỤC ---
        let currentRating = 0;

        // --- CẬP NHẬT HÀM showBookDetails ---
        function showBookDetails(bookId) {
            var myModal = new bootstrap.Modal(document.getElementById('bookDetailModal'));

            // Reset modal loading
            $('#bookDetailContent').html('<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>');
            myModal.show();

            $.ajax({
                url: '/Shopping/GetBookDetails',
                type: 'GET',
                data: { id: bookId },
                success: function (response) {
                    $('#bookDetailContent').html(response);

                    // QUAN TRỌNG: Cập nhật lại điểm đánh giá từ dữ liệu vừa tải về
                    currentRating = parseInt($('#selectedRating').val() || 0);
                },
                error: function () {
                    $('#bookDetailContent').html('<div class="text-center p-5 text-danger">Lỗi tải dữ liệu.</div>');
                }
            });
        }

        // --- CÁC HÀM XỬ LÝ ĐÁNH GIÁ (Chuyển từ Modal sang đây) ---

        // 1. Hiệu ứng Hover
        function highlightStars(starValue) {
            const stars = document.querySelectorAll('.star-item');
            stars.forEach(star => {
                const val = parseInt(star.getAttribute('data-value'));
                if (val <= starValue) {
                    star.classList.remove('text-secondary');
                    star.classList.add('text-warning');
                } else {
                    star.classList.remove('text-warning');
                    star.classList.add('text-secondary');
                }
            });
        }

        // 2. Reset Hover
        function resetStars() {
            highlightStars(currentRating);
        }

        // 3. Click chọn sao
        function selectRating(val) {
            currentRating = val;
            // Cập nhật giá trị vào input ẩn trong modal (nếu cần dùng sau này)
            const input = document.getElementById('selectedRating');
            if (input) input.value = val;

            highlightStars(val);
        }

        // 4. Gửi đánh giá
        function submitRating(bookId) {
            if (currentRating === 0) {
                alert("Vui lòng chọn số sao để đánh giá!");
                return;
            }

            const comment = document.getElementById('ratingComment').value;
            const btn = event.target;
            const originalText = btn.innerText;

            btn.disabled = true;
            btn.innerText = "Đang gửi...";

            $.ajax({
                url: '/Shopping/RateBook',
                type: 'POST',
                data: {
                    bookId: bookId,
                    ratingValue: currentRating,
                    comment: comment
                },
                success: function (res) {
                    btn.disabled = false;
                    btn.innerText = originalText;

                    if (res.success) {
                        alert(res.message);
                        // Cập nhật UI
                        $('#totalRatingsDisplay').text(res.newTotal);
                        let starsHtml = '';
                        for (let i = 1; i <= 5; i++) {
                            if (res.newAverage >= i) starsHtml += '<i class="fas fa-star"></i> ';
                            else if (res.newAverage >= i - 0.5) starsHtml += '<i class="fas fa-star-half-alt"></i> ';
                            else starsHtml += '<i class="far fa-star"></i> ';
                        }
                        $('#avgRatingDisplay').html(starsHtml);
                    } else {
                        alert(res.message);
                    }
                },
                error: function () {
                    btn.disabled = false;
                    btn.innerText = originalText;
                    alert("Có lỗi xảy ra khi gửi đánh giá.");
                }
            });
        }

        function adjustQty(amount) {
            var input = document.getElementById('modalQuantity');
            var currentVal = parseInt(input.value);
            var maxVal = parseInt(input.max);
            var newVal = currentVal + amount;
            if (newVal >= 1 && newVal <= maxVal) {
                input.value = newVal;
            }
        }
    </script>
}