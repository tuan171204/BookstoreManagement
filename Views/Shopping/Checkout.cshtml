@model BookstoreManagement.Models.AppUser
@{
    ViewData["Title"] = "Thanh to√°n";
    Layout = "~/Views/Shared/_LayoutClient.cshtml";
}

<div class="container py-5">
    <div class="row">
        <div class="col-md-7">
            <h4 class="mb-3 fw-bold text-primary"><i class="fas fa-shipping-fast me-2"></i>Th√¥ng tin giao h√†ng</h4>
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <form id="checkoutForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">H·ªç v√† t√™n <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="cxName" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n"
                                    required value="@(User.Identity.IsAuthenticated? User.Identity.Name : "")">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i <span
                                        class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="cxPhone" placeholder="V√≠ d·ª•: 0912345678"
                                    required value="@(User.Identity.IsAuthenticated? @Model.PhoneNumber: "")">
                            </div>

                            @if (User.Identity.IsAuthenticated && Model != null && !string.IsNullOrEmpty(Model.Address))
                            {
                                <div class="mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="addressOption" id="addrDefault"
                                            value="default" checked onchange="toggleAddressInput()">
                                        <label class="form-check-label" for="addrDefault">
                                            S·ª≠ d·ª•ng ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh: <strong>@Model.Address</strong>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="addressOption" id="addrNew"
                                            value="new" onchange="toggleAddressInput()">
                                        <label class="form-check-label" for="addrNew">
                                            Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng m·ªõi
                                        </label>
                                    </div>
                                </div>

                                <input type="text" class="form-control mt-2" id="cxAddress"
                                    placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi..." style="display:none;">

                                <input type="hidden" id="defaultAddressVal" value="@Model.Address" />
                            }
                            else
                            {
                                <input type="text" class="form-control" id="cxAddress"
                                    placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£..." required>
                            }

                            <div class="col-12">
                                <label class="form-label fw-bold">Ghi ch√∫ ƒë∆°n h√†ng</label>
                                <textarea class="form-control" id="cxNote" rows="2"
                                    placeholder="V√≠ d·ª•: Giao gi·ªù h√†nh ch√≠nh..."></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold"><i class="fas fa-ticket-alt text-warning me-1"></i> M√£
                                    khuy·∫øn m√£i (H√≥a ƒë∆°n)</label>
                                <select class="form-select" id="promotionSelect" asp-items="ViewBag.OrderPromotions">
                                    <option value="">-- Kh√¥ng √°p d·ª•ng --</option>
                                </select>
                                <div class="form-text small">Ch·ªâ √°p d·ª•ng cho t·ªïng gi√° tr·ªã ƒë∆°n h√†ng sau khi ƒë√£ tr·ª´ khuy·∫øn
                                    m√£i t·ª´ng s·∫£n ph·∫©m.</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <h4 class="mb-3 fw-bold text-primary"><i class="fas fa-wallet me-2"></i>Ph∆∞∆°ng th·ª©c thanh to√°n</h4>
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="payCOD" value="Cash"
                            checked>
                        <label class="form-check-label fw-bold" for="payCOD">
                            <i class="fas fa-money-bill-wave text-success me-2"></i>Thanh to√°n khi nh·∫≠n h√†ng (COD)
                        </label>
                        <div class="text-muted small ms-4">B·∫°n s·∫Ω thanh to√°n ti·ªÅn m·∫∑t cho shipper khi nh·∫≠n ƒë∆∞·ª£c h√†ng.
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="payTransfer"
                            value="Transfer">
                        <label class="form-check-label fw-bold" for="payTransfer">
                            <i class="fas fa-qrcode text-primary me-2"></i>Chuy·ªÉn kho·∫£n ng√¢n h√†ng (VietQR)
                        </label>
                        <div class="text-muted small ms-4">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n nhanh ch√≥ng.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <h4 class="mb-3 fw-bold text-primary"><i class="fas fa-shopping-bag me-2"></i>ƒê∆°n h√†ng c·ªßa b·∫°n</h4>
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div id="checkoutItemsList" class="mb-3" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center py-4 text-muted">
                            <div class="spinner-border spinner-border-sm text-primary"></div> ƒêang t·∫£i ƒë∆°n h√†ng...
                        </div>
                    </div>

                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>T·∫°m t√≠nh</span>
                            <strong id="checkoutSubTotal">0 ƒë</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                            <span class="text-success">Mi·ªÖn ph√≠</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between bg-light">
                            <span class="fw-bold text-success fs-5">T·ªîNG C·ªòNG</span>
                            <span class="fw-bold text-success fs-5" id="checkoutTotal">0 ƒë</span>
                        </li>
                    </ul>

                    <button class="btn btn-primary w-100 btn-lg py-3 fw-bold text-uppercase"
                        onclick="processCheckout()">
                        ƒê·∫∂T H√ÄNG NGAY
                    </button>
                    <a asp-action="Index" class="btn btn-link w-100 text-decoration-none mt-2">Ti·∫øp t·ª•c mua s·∫Øm</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Thanh to√°n chuy·ªÉn kho·∫£n</h5>
            </div>
            <div class="modal-body text-center">
                <p class="mb-3">Vui l√≤ng qu√©t m√£ QR b√™n d∆∞·ªõi ƒë·ªÉ thanh to√°n</p>
                <img id="vietqr-image" src="" class="img-fluid border rounded shadow mb-3" style="max-width: 250px;">
                <h4 class="text-danger fw-bold" id="qr-amount"></h4>
                <p class="text-muted small">N·ªôi dung: <b id="qr-content"></b></p>
                <div class="alert alert-info small text-start">
                    Sau khi chuy·ªÉn kho·∫£n, vui l√≤ng ·∫•n n√∫t <b>"T√¥i ƒë√£ chuy·ªÉn kho·∫£n"</b> ƒë·ªÉ ho√†n t·∫•t.
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Quay l·∫°i</button>
                <button class="btn btn-success" onclick="submitOrderToServer()">T√¥i ƒë√£ chuy·ªÉn kho·∫£n</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // C·∫•u h√¨nh Ng√¢n h√†ng (Gi·ªëng b√™n Sales)
        const MY_BANK = {
            BANK_ID: 'BIDV', ACCOUNT_NO: '1170206622', ACCOUNT_NAME: 'VƒÉn Th√†nh Thi·ªán', TEMPLATE: 'compact'
        };

        let checkoutCartItems = []; // L∆∞u chi ti·∫øt ƒë·ªÉ g·ª≠i v·ªÅ server

        $(document).ready(function () {
            loadCheckoutCart();

            // G·ªçi h√†m n√†y 1 l·∫ßn khi trang load ƒë·ªÉ thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu
            if ($('input[name="addressOption"]').length > 0) {
                toggleAddressInput();
            }
        });

        function loadCheckoutCart() {
            // L·∫•y cart t·ª´ localStorage (bi·∫øn to√†n c·ª•c t·ª´ _LayoutClient)
            const storedCart = localStorage.getItem('bookstore_client_cart');
            if (!storedCart || JSON.parse(storedCart).length === 0) {
                window.location.href = '/Shopping/Index'; // Gi·ªè tr·ªëng th√¨ ƒë√° v·ªÅ trang ch·ªß
                return;
            }

            const localCart = JSON.parse(storedCart);
            const bookIds = localCart.map(i => i.id).join(',');

            // G·ªçi API l·∫•y th√¥ng tin chi ti·∫øt
            $.ajax({
                url: '/Shopping/GetCartDetails',
                type: 'GET',
                data: { bookIds: bookIds },
                success: function (res) {
                    if (res.success) {
                        renderCheckoutItems(res.items, localCart);
                    }
                }
            });
        }

        // --- H√ÄM M·ªöI: X·ª≠ l√Ω ·∫©n hi·ªán √¥ nh·∫≠p ƒë·ªãa ch·ªâ ---
        function toggleAddressInput() {
            // Ki·ªÉm tra xem radio button "ƒê·ªãa ch·ªâ m·ªõi" c√≥ ƒë∆∞·ª£c ch·ªçn kh√¥ng
            const isNewAddr = $('#addrNew').is(':checked');

            if (isNewAddr) {
                $('#cxAddress').show().val('').focus(); // Hi·ªán √¥ nh·∫≠p v√† x√≥a tr·∫Øng
            } else {
                // N·∫øu ch·ªçn m·∫∑c ƒë·ªãnh -> ·∫®n √¥ nh·∫≠p v√† g√°n gi√° tr·ªã m·∫∑c ƒë·ªãnh v√†o n√≥ (ho·∫∑c x·ª≠ l√Ω l√∫c submit)
                $('#cxAddress').hide().val($('#defaultAddressVal').val());
            }
        }

        function renderCheckoutItems(dbItems, localItems) {
            let html = '';
            let total = 0;
            checkoutCartItems = [];

            localItems.forEach(local => {
                const db = dbItems.find(x => x.bookId === local.id);
                if (db) {
                    const sub = db.price * local.qty;
                    total += sub;

                    checkoutCartItems.push({ BookId: local.id, Quantity: local.qty });

                    // --- LOGIC HI·ªÇN TH·ªä GI√Å (M·ªöI) ---
                    let priceDisplay = '';
                    if (db.price < db.originalPrice) {
                        // C√≥ gi·∫£m gi√°: Hi·ªán gi√° g·ªëc g·∫°ch ngang + Gi√° m·ªõi m√†u ƒë·ªè
                        priceDisplay = `
                        <div class="d-flex flex-column">
                            <small class="text-decoration-line-through text-muted" style="font-size: 12px;">
                                ${db.originalPrice.toLocaleString('vi-VN')} ƒë
                            </small>
                            <span class="text-danger fw-bold">
                                ${db.price.toLocaleString('vi-VN')} ƒë
                            </span>
                        </div>
                    `;
                    } else {
                        // Kh√¥ng gi·∫£m gi√°
                        priceDisplay = `<span class="text-muted">${db.price.toLocaleString('vi-VN')} ƒë</span>`;
                    }
                    // ---------------------------------

                    html += `
                    <div class="d-flex mb-3 align-items-center border-bottom pb-2">
                        <img src="${db.imageUrl}" class="rounded border me-3" style="width: 50px; height: 75px; object-fit: cover;">
                        <div class="flex-grow-1">
                            <h6 class="mb-0 text-truncate" style="max-width: 200px;">${db.title}</h6>
                            <div class="d-flex align-items-center gap-2 mt-1">
                                ${priceDisplay}
                                <small class="text-muted">x ${local.qty}</small>
                            </div>
                        </div>
                        <span class="fw-bold text-dark">${sub.toLocaleString('vi-VN')} ƒë</span>
                    </div>
                `;
                }
            });

            $('#checkoutItemsList').html(html);
            $('#checkoutSubTotal').text(total.toLocaleString('vi-VN') + ' ƒë');
            $('#checkoutTotal').text(total.toLocaleString('vi-VN') + ' ƒë');
            $('#checkoutTotal').data('value', total);
        }

        function processCheckout() {
            // 1. Validate Form
            const name = $('#cxName').val().trim();
            const phone = $('#cxPhone').val().trim();

            // --- S·ª¨A LOGIC L·∫§Y ƒê·ªäA CH·ªà ---
            let address = "";

            // Ki·ªÉm tra xem c√≥ radio button l·ª±a ch·ªçn kh√¥ng
            if ($('input[name="addressOption"]').length > 0) {
                if ($('#addrDefault').is(':checked')) {
                    address = $('#defaultAddressVal').val(); // L·∫•y t·ª´ bi·∫øn ·∫©n
                } else {
                    address = $('#cxAddress').val().trim(); // L·∫•y t·ª´ √¥ nh·∫≠p
                }
            } else {
                // Tr∆∞·ªùng h·ª£p kh√°ch v√£ng lai
                address = $('#cxAddress').val().trim();
            }

            if (!name || !phone || !address) {
                showToast('warning', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!');
                if ($('input[name="addressOption"]').length > 0 && $('#addrNew').is(':checked')) {
                    $('#cxAddress').focus();
                }
                return;
            }

            $('#cxAddress').val(address);

            // 2. Check Payment Method
            const method = $('input[name="paymentMethod"]:checked').val();

            if (method === 'Transfer') {
                showQRCodeModal();
            } else {
                if (confirm("X√°c nh·∫≠n ƒë·∫∑t h√†ng thanh to√°n khi nh·∫≠n h√†ng (COD)?")) {
                    submitOrderToServer();
                }
            }
        }

        function showQRCodeModal() {
            const total = $('#checkoutTotal').data('value');
            const content = "DH" + Math.floor(Math.random() * 1000000);
            const qrUrl = `https://img.vietqr.io/image/${MY_BANK.BANK_ID}-${MY_BANK.ACCOUNT_NO}-${MY_BANK.TEMPLATE}.png?amount=${total}&addInfo=${content}&accountName=${encodeURIComponent(MY_BANK.ACCOUNT_NAME)}`;

            $('#vietqr-image').attr('src', qrUrl);
            $('#qr-amount').text(total.toLocaleString('vi-VN') + ' ƒë');
            $('#qr-content').text(content);

            new bootstrap.Modal(document.getElementById('qrModal')).show();
        }

        function submitOrderToServer() {
            // Disable button ƒë·ªÉ tr√°nh double click
            const btn = event.target;
            // btn.disabled = true; 

            const promoId = $('#promotionSelect').val();

            const payload = {
                CustomerName: $('#cxName').val(),
                CustomerPhone: $('#cxPhone').val(),
                Address: $('#cxAddress').val(),
                PaymentMethod: $('input[name="paymentMethod"]:checked').val(),
                PromotionId: promoId ? parseInt(promoId) : 0,
                CartItems: checkoutCartItems
            };

            $.ajax({
                url: '/Shopping/PlaceOrder',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (res) {
                    if (res.success) {
                        // X√≥a gi·ªè h√†ng local
                        localStorage.removeItem('bookstore_client_cart');
                        // Reset UI gi·ªè h√†ng
                        if (typeof initializeCart === 'function') initializeCart();

                        showToast('success', 'üéâ ' + res.message);
                        // Th√™m delay nh·ªè tr∆∞·ªõc khi chuy·ªÉn trang ƒë·ªÉ ng∆∞·ªùi d√πng k·ªãp ƒë·ªçc
                        setTimeout(() => {
                            window.location.href = '/Shopping/Index';
                        }, 2000);
                    } else {
                        showToast('danger', 'Thanh to√°n th·∫•t b·∫°i: ' + res.message);
                        // btn.disabled = false;
                    }
                },
                error: function () {
                    showToast('danger', 'L·ªói k·∫øt n·ªëi server');
                }
            });
        }
    </script>
}