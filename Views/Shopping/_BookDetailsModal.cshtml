@model BookstoreManagement.Models.Book

@{
    // Cast ViewBag promotion object to dynamic để truy cập các thuộc tính
    dynamic promo = ViewBag.ActivePromotion;
    bool isOnSale = promo != null;
    decimal oldPrice = Model.Price;
    decimal newPrice = Model.Price;
    string promoBadge = "";

    if (isOnSale)
    {
        int typeId = (int)promo.TypeId; // 1: Percent, 2: Fixed Amount, 3: Gift
        decimal discountValue = promo.Discount ?? 0;
        string discountName = promo.Name ?? "Khuyến mãi";

        if (typeId == 1 && Model.Price > 0) // Giảm %
        {
            newPrice = Model.Price * (1 - discountValue / 100);
            promoBadge = $"<span class='badge bg-danger'>SALE -{discountValue}%</span>";
        }
        else if (typeId == 2) // Giảm tiền mặt
        {
            newPrice = Model.Price - discountValue;
            if (newPrice < 0) newPrice = 0;
            promoBadge = $"<span class='badge bg-danger'>GIẢM {discountValue:N0}đ</span>";
        }
        else if (typeId == 3) // Quà tặng
        {
            promoBadge = $"<span class='badge bg-danger'>QUÀ TẶNG</span>";
            newPrice = oldPrice;
        }
    }
}

<div class="modal-header border-0 pb-0">
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
    <div class="row">
        <div class="col-md-5 text-center mb-3 mb-md-0">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" class="img-fluid rounded shadow-sm" alt="@Model.Title"
                    style="max-height: 400px; object-fit: contain;">
            }
            else
            {
                <div class="bg-light d-flex align-items-center justify-content-center rounded text-muted"
                    style="height: 300px;">
                    <i class="fas fa-image fa-3x"></i>
                </div>
            }

            <div class="mb-2 mt-4">
                <div class="fs-4 text-warning" id="avgRatingDisplay">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (Model.AverageRating >= i)
                        {
                            <i class="fas fa-star"></i>
                        }
                        else if (Model.AverageRating >= i - 0.5)
                        {

                            <i class="fas fa-star-half-alt"></i>
                        }
                        else
                        {

                            <i class="far fa-star"></i>
                        }
                    }
                </div>
                <span class="text-muted small">
                    (<span id="totalRatingsDisplay">@Model.TotalRatings</span> đánh giá)
                </span>
            </div>

            <div class="card bg-light border-0 p-3">
                <h6 class="fw-bold"><i class="fas fa-pen-nib"></i> Đánh giá của bạn</h6>

                @if (User.Identity.IsAuthenticated)
                {
                    <div class="rating-input mb-2">
                        @for (int i = 1; i <= 5; i++)
                        {
                            // Kiểm tra nếu user đã đánh giá trước đó (ViewBag truyền từ Controller)
                            var isChecked = (ViewBag.CurrentUserRating != null && ViewBag.CurrentUserRating >= i) ?
                            "text-warning" : "text-secondary";
                            <i class="fas fa-star fa-lg cursor-pointer star-item @isChecked" data-value="@i"
                                style="cursor: pointer;" onmouseover="highlightStars(@i)" onmouseout="resetStars()"
                                onclick="selectRating(@i)"></i>
                        }
                    </div>
                    <input type="hidden" id="selectedRating" value="@(ViewBag.CurrentUserRating ?? 0)" />

                    <div class="mb-2">
                        <textarea id="ratingComment" class="form-control form-control-sm" rows="2"
                        placeholder="Nhập bình luận của bạn..."></textarea>
                    </div>
                    <button class="btn btn-sm btn-warning" onclick="submitRating(@Model.BookId)">
                        Gửi đánh giá
                    </button>
                }
                else
                {
                    <p class="small text-muted mb-0">
                        Vui lòng <a href="/Account/Login" class="text-primary">đăng nhập</a> để đánh giá sách này.
                    </p>
                }
            </div>
        </div>

        <div class="col-md-7">
            <h3 class="fw-bold text-primary">@Model.Title</h3>



            <div class="mb-3">
                <span class="badge bg-info text-dark me-2 p-2" style="font-size: 14px">
                    <i class="fas fa-user-edit"></i> @(Model.Author?.Name ?? "Đang cập nhật")
                </span>
                @if (Model.BookCategories != null && Model.BookCategories.Any())
                {
                    foreach (var cat in Model.BookCategories)
                    {
                        <span class="badge bg-light text-secondary border p-2">@cat.Category.Name</span>
                    }
                }
            </div>

            <div class="mb-4">
                @if (isOnSale && newPrice < oldPrice)
                {
                    <h2 class="text-danger fw-bold mb-0">@newPrice.ToString("N0") đ</h2>
                    <del class="text-muted small">Giá gốc: @oldPrice.ToString("N0") đ</del>
                }
                else
                {
                    <h2 class="text-danger fw-bold mb-0">@oldPrice.ToString("N0") đ</h2>
                }

                @if ((Model.StockQuantity ?? 0) > 0)
                {
                    <span class="text-success small"><i class="fas fa-check-circle"></i> Còn hàng (@Model.StockQuantity
                        quyển)</span>
                }
                else
                {
                    <span class="text-danger small"><i class="fas fa-times-circle"></i> Hết hàng</span>
                }
            </div>

            @if (isOnSale)
            {
                <div class="mb-2">
                    @Html.Raw(promoBadge)
                    <span class="small text-danger fw-bold ms-1 p-2">@promo.Name</span>
                    @if (promo.MinPurchase > 0)
                    {
                        <span class="small text-warning ms-2">(ĐH tối thiểu: @promo.MinPurchase.ToString("N0") đ)</span>
                    }
                </div>
            }

            <div class="d-flex gap-2 mb-4">
                <div class="input-group" style="width: 120px;">
                    <button class="btn btn-outline-secondary" type="button" onclick="adjustQty(-1)">-</button>
                    <input type="number" class="form-control text-center" value="1" min="1"
                        max="@(Model.StockQuantity ?? 1)" id="modalQuantity">
                    <button class="btn btn-outline-secondary" type="button" onclick="adjustQty(1)">+</button>
                </div>
                <button class="btn btn-primary flex-grow-1"
                    onclick="addToCart(@Model.BookId, parseInt($('#modalQuantity').val()))"">
                    <i class=" fas fa-cart-plus me-2"></i> Thêm vào giỏ
                </button>
            </div>

            <hr />

            <div class="small text-muted mb-4">
                <p class="mb-1"><strong>Nhà xuất bản:</strong> @(Model.Publisher?.Name ?? "N/A")</p>
                <p class="mt-3"><strong>Năm xuất bản:</strong> @(Model.PublicationYear?.ToString() ?? "N/A")</p>
                <div class="mt-3">
                    <strong>Mô tả:</strong>
                    <p class="mt-1 text-justify">
                        @(string.IsNullOrEmpty(Model.Description) ? "Chưa có mô tả." : Model.Description)
                    </p>
                </div>
            </div>


        </div>
    </div>
</div>